# NodeJS熔断器模式实战演示

## 简介
本演示展示了在Node.js中如何使用熔断器（Circuit Breaker）模式来增强系统的容错能力。当远程服务不稳定时，熔断器可以防止级联故障，提升系统稳定性。

## 学习目标
- 理解熔断器模式的三种状态：关闭、打开、半开
- 掌握在Node.js中集成熔断器的实践方法
- 学会通过熔断器实现服务降级和快速失败

## 环境要求
- Node.js 版本：14.x 或更高（推荐使用 LTS 版本）
- npm 包管理工具（随Node.js自动安装）
- 操作系统：Windows / Linux / macOS（跨平台兼容）

## 安装依赖的详细步骤
1. 打开终端或命令行工具
2. 进入项目根目录：`cd path/to/your/project`
3. 安装所需依赖包：
   ```bash
   npm install
   ```

## 文件说明
- `circuit-breaker-demo.js`：主程序，演示正常请求与异常情况下的熔断行为
- `fallback-service.js`：提供降级服务逻辑，在熔断开启时返回默认值
- `package.json`：项目依赖声明文件

## 逐步实操指南

### 步骤1：初始化项目
```bash
npm init -y
```
**预期输出**：生成 `package.json` 文件

### 步骤2：安装熔断器库
```bash
npm install circuit-breaker-js
```
**预期输出**：成功下载并安装 `circuit-breaker-js` 到 node_modules

### 步骤3：运行演示程序
```bash
node circuit-breaker-demo.js
```

**预期输出**：
```
调用服务... 响应: 成功响应
调用服务... 响应: 成功响应
调用服务... 错误: 模拟网络超时
调用服务... 错误: 模拟网络超时
调用服务... 熔断器已开启，执行降级逻辑
调用服务... 熔断器已开启，执行降级逻辑
```

## 代码解析

### circuit-breaker-demo.js
- 使用 `CircuitBreaker` 包装不稳定的远程调用函数
- 配置失败阈值为2次，超时时间为5秒
- 当连续失败达到阈值后，熔断器进入“打开”状态，阻止后续请求直接失败

### fallback-service.js
- 提供 `getFallbackData` 方法作为降级响应
- 在主服务不可用时返回安全默认值，保障用户体验

## 预期输出示例
```
[时间] 调用服务... 响应: 成功响应
[时间] 调用服务... 响应: 成功响应
[时间] 调用服务... 错误: 模拟网络超时
[时间] 调用服务... 错误: 模拟网络超时
[时间] 调用服务... 熔断器已开启，执行降级逻辑
[时间] 调用服务... 熔断器已开启，执行降级逻辑
```

## 常见问题解答

**Q: 为什么需要熔断器？**
A: 防止一个服务的延迟或崩溃引发整个系统雪崩，提升整体健壮性。

**Q: 熔断器什么时候恢复？**
A: 在“打开”状态持续一段时间后，会进入“半开”状态，尝试放行部分请求测试服务是否恢复。

**Q: 如何调整熔断策略？**
A: 修改 `options` 中的 `threshold` 和 `timeout` 参数即可自定义策略。

## 扩展学习建议
- 尝试结合 Express 构建REST API网关，对下游服务调用启用熔断
- 集成日志记录（如 Winston）观察熔断状态变化
- 探索更高级的库如 `Opossum` 支持超时、重试等复合策略