apiVersion: v1
kind: ConfigMap
metadata:
  name: n8n-config
  namespace: n8n-system
data:
  # 主配置
  config.yaml: |
    n8n:
      host: 0.0.0.0
      port: 5678
      protocol: http
      webhook:
        url: http://n8n.example.com
      encryptionKey: ${N8N_ENCRYPTION_KEY}
      database:
        type: postgres
        host: postgres
        port: 5432
        user: n8n
        password: ${POSTGRES_PASSWORD}
        database: n8n
  # 启动脚本
  start.sh: |
    #!/bin/bash
    set -e
    
    echo "Starting n8n..."
    
    # 加载环境变量
    export N8N_ENCRYPTION_KEY=$(cat /etc/secrets/n8n-encryption-key)
    export POSTGRES_PASSWORD=$(cat /etc/secrets/postgres-password)
    
    # 启动服务
    n8n start
  # 监控配置
  prometheus.yaml: |
    global:
      scrape_interval: 15s
    scrape_configs:
      - job_name: 'n8n'
        kubernetes_sd_configs:
          - role: pod
        relabel_configs:
          - source_labels: [__meta_kubernetes_pod_label_app]
            regex: n8n
            action: keep